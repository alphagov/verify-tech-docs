---
title: Set up the successful verification user journey
weight: 10
---

# Set up the successful verification user journey

This guide is the first step in integrating your service with the Verify Service Provider (VSP). The VSP allows your service to communicate with the GOV.UK Verify Hub securely, without having to handle [SAML][saml].

Find out how to set up the successful verification journey, including:

- generating an authentication request using the VSP
- sending the authentication request to the GOV.UK Verify Hub
- translating a SAML response using the VSP
- linking an authentication request with its response

This guide uses the GOV.UK Verify test tool as a placeholder for the GOV.UK Verify Hub. The test tool is hosted by the GOV.UK Verify team which means you can follow along using your local VSP setup.

## Prerequisites

[Download the latest VSP release][vsp-release] to be able to follow the instructions on this page.

## Using the VSP with the test tool

To use the VSP with the test tool, you need to run the VSP in [development mode][dev-mode]. Running the VSP in development mode initialises and configures the test tool and the VSP to connect to each other.

To start the VSP in development mode, run:

```sh
./bin/verify-service-provider development -u localhost:8080
```

The example sets `http://localhost:8080` as the endpoint where the test tool will send the SAML responses.

## Send a request

Once the user starts a Verify journey from the browser, your service must send a request to the VSP to generate the authentication request. Then, your service must send the authentication request to the test tool via the browser. The authentication request is also known as a SAML AuthnRequest.

![](/images/vsp-integration-request.svg)

### Generate an authentication request

Make an HTTP POST request to the `/generate-request` endpoint to generate an authentication request message. The request body must contain the [level of assurance][loa] for your service:

```
> POST /generate-request HTTP/1.1
> Content-Type: application/json
>
> { "levelOfAssurance": "LEVEL_2" }
```

### Receive the authentication request

The response from the VSP is in JSON format, and contains the authentication request:

```json
{
    "samlRequest": "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbDJwOkF1dGhuUmVxdWVzdCB4bWxuczpzYW1sMnA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCIgRGVzdGluYXRpb249Imh0dHBzOi8vY29tc...",
    "requestId": "_f43aa274-9395-45dd-aaef-25f56f49084e",
    "ssoLocation": "https://compliance-tool-reference.ida.digital.cabinet-office.gov.uk/SAML2/SSO"
}
```

The parts of the response are:

| Field         | Description                                            |
| ------------- | ------------------------------------------------------ |
| `samlRequest` | Your base64 encoded SAML authentication request                |
| `requestId`   | A string that identifies the SAML authentication request       |
| `ssoLocation` | The URL to send the authentication request to, for example the test tool. |

#### Store the requestId

You will need to access the `requestId` later in the process to link the identities received from GOV.UK Verify with the correct user.

You must store the `requestId` securely and link it to the user's session. We recommend you store the `requestId` in a secure cookie.

### Send the authentication request to the test tool

After receiving the authentication request, your service sends it to the test tool via the browser. We recommend you do this by rendering an HTML form and using JavaScript to auto-submit it, as described by [SAML HTTP Post Binding](https://en.wikipedia.org/wiki/SAML_2.0#HTTP_POST_Binding) [external link]:

```html
<!-- The form containing the SAML authentication request
to be submitted to the test tool -->
<form method='post' action='${escape(ssoLocation)}'>
  <h1>Continue to next step</h1>
  <p>Because Javascript is not enabled on your browser, you must press the continue button</p>
  <input type='hidden' name='SAMLRequest' value='${escape(samlRequest)}'/>
  <input type='hidden' name='relayState' value=''/>
  <button>Continue</button>
</form>

<!-- JavaScript to automatically submit the form
and POST to `ssoLocation` -->
<script>
  var form = document.forms[0]
  form.setAttribute('style', 'display: none;')
  window.setTimeout(function () { form.removeAttribute('style') }, 5000)
  form.submit()
</script>
```
Make sure to escape inputs so that special characters are not processed. In our example, we are using the Express framework's escape method when rendering the form.

For a consistent user journey, we recommend you also include page styling matching the appearance of your service. The styling is for the page that appears if a user has JavaScript disabled. This page prompts users to turn on JavaScript and should look like your service.

### Response from the test tool

After the form is submitted, the test tool response should contain `"status": "PASSED"` and a `responseGeneratorLocation` URL which you can use to access the test scenarios:

```json
  {
    "status": {
      "status": "PASSED",
      "message": null
    },
    "responseGeneratorLocation": "https://compliance-tool-reference.ida.digital.cabinet-office.gov.uk:443/rp-test/_5178cb11-bc5a-4124-8c61-f8bac98e1db6"
  }
```

If the status is not `PASSED` then you may need to restart the VSP.

## Handle your first response scenario

Go to the URL in `responseGeneratorLocation` using your browser. The JSON response contains the 4 test cases or scenarios your service must handle when live.

Here we'll focus on the first test case, which simulates a user who has been successfully verified:

```json
{
  "executeUri" : "https://compliance-tool-reference.ida.digital.cabinet-office.gov.uk:443/rp-test/_6817b389-4924-479c-9851-db089c4e639c/test-non-matching/10",
  "id" : 10,
  "title" : "FIXME",
  "description" : "Issues a successful response where the user has been successfully verified."
},
```
Each scenario is characterised by has a title, description, id, and a executeUri, which can be followed to run the scenarion. (FIXME I want to be a table)

| Parameter     | Description                       |
| ------------- | --------------------------------- |
| `executeUri`  | URI for running the test scenario |
| `id`          | Number identifying the scenario   |
| `title`       | The name of the scenario          |
| `description` | Details about the scenario        |

### Run the scenario
Using your response find the scenario that has a title: blah and go to the `executeUri` location to run the scenario.

### Handle the response

![](/images/vsp-integration-response.svg)

The test tool will generate a SAML response that will be provided in a HTML form that when submitted will be sent to the URL you provided to the VSP when launching development mode.
Your service must be listening at that URL for the incoming form submission.
The SAML response will be base64 encoded within the `SAMLResponse` form parameter:

```
SAMLResponse=PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHNhbWwycDpSZXNwb25zZSBEZXN0aW5hdGlvbj0iaHR0cHM6Ly9wYXNzcG9ydC12ZXJpZnktc3R1Yi1yZWx5aW5nLXBhcnR5LWRldi5jbG91ZGFwcHMuZGlnaXRhbC92ZXJpZnkv...
```

From your service, make a HTTP POST request to `/translate-response` to translate the SAML Response into JSON.

The request must contain:

| Parameter          | Description                                                      |
| ------------------ | ---------------------------------------------------------------- |
| `samlResponse`     | Base64 encoded SAML response from the test tool                  |
| `requestId`        | Bhe string your saved when generating the authentication request |
| `levelOfAssurance` | The [level of assurance][loa] for your service                                                                 |

```http
> POST /translate-response HTTP/1.1
> Content-Type: application/json
>
{
  "samlResponse" : "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbDJwOkF1dGhuUmVxdWVzdCB4bWxuczpzYW1sMnA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCIgRGVzdGluYXRpb249Imh0dHBzOi8vY29tc...",
  "requestId" : "_64c90b35-154f-4e9f-a75b-3a58a6c55e8b",
  "levelOfAssurance" : "LEVEL_2"
}
```

An `HTTP 200 OK` response confirms the VSP translated the SAML response successfully and also contains details about the test scenario:

```http
> HTTP/1.1 200 OK
> Content-Type: application/json
>
{
    "scenario": "IDENTITY_VERIFIED",
    "pid": "etikgj3ewowe",
    "levelOfAssurance": "LEVEL_2",
    "attributes": pie
}
```

For a successful verification journey, the response contains information about the user's identity:

| Parameter          | Description                                 |
| ------------------ | ------------------------------------------- |
| `scenario`         | The name of the scenario you're testing     |
| `pid`              | A unique identifier for a user              |
| `levelOfAssurance` | The level of assurance the user verified at |
| `attributes`       | Information about the user's identity       |


Your service can now use the provided identity to further guide the user in their journey in your service.

##Â Next Steps [rephrase]

- Handle other scenarios (no_authn_context, and authn_failed)
- Test with different identities:
    - levels of assurance
    - test your matching strategy
      - different user attribtues (variety of names)
      - historical attributes






<%= partial "partials/links" %>
